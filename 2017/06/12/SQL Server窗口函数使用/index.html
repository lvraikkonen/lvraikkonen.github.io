<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="SQL Server,SQL," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="什么是窗口函数 Windows Function窗口函数属于集合函数，作用在行集上，下面这段关于窗口函数的介绍来自 PostgreSQL intro windows function  A window function performs a calculation across a set of table rows that are somehow related to the current">
<meta name="keywords" content="SQL Server,SQL">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL Server窗口函数使用">
<meta property="og:url" content="https://lvraikkonen.github.io/2017/06/12/SQL Server窗口函数使用/index.html">
<meta property="og:site_name" content="Claus&#39;s Tech Blog">
<meta property="og:description" content="什么是窗口函数 Windows Function窗口函数属于集合函数，作用在行集上，下面这段关于窗口函数的介绍来自 PostgreSQL intro windows function  A window function performs a calculation across a set of table rows that are somehow related to the current">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://7xkfga.com1.z0.glb.clouddn.com/executionCompare1.png">
<meta property="og:image" content="http://7xkfga.com1.z0.glb.clouddn.com/rowNumber.png">
<meta property="og:image" content="http://7xkfga.com1.z0.glb.clouddn.com/partitionGroup.png">
<meta property="og:image" content="http://7xkfga.com1.z0.glb.clouddn.com/rowsWindow.png">
<meta property="og:image" content="http://7xkfga.com1.z0.glb.clouddn.com/rows2.png">
<meta property="og:image" content="http://7xkfga.com1.z0.glb.clouddn.com/RANGE2.png">
<meta property="og:updated_time" content="2018-04-04T07:08:31.538Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SQL Server窗口函数使用">
<meta name="twitter:description" content="什么是窗口函数 Windows Function窗口函数属于集合函数，作用在行集上，下面这段关于窗口函数的介绍来自 PostgreSQL intro windows function  A window function performs a calculation across a set of table rows that are somehow related to the current">
<meta name="twitter:image" content="http://7xkfga.com1.z0.glb.clouddn.com/executionCompare1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'JWQGEFMRGT',
      apiKey: '7c12daa85b9bf759fcde9b547d3a9349',
      indexName: 'lvraikkonen_blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://lvraikkonen.github.io/2017/06/12/SQL Server窗口函数使用/"/>





  <title>SQL Server窗口函数使用 | Claus's Tech Blog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Claus's Tech Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">leave me alone i know what to do</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://lvraikkonen.github.io/2017/06/12/SQL Server窗口函数使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shuo Lv">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Claus's Tech Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">SQL Server窗口函数使用</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-12T15:43:28+08:00">
                2017-06-12
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-04-04T15:08:31+08:00">
                2018-04-04
              </time>
            
          </span>

          

          
            
          

          
          
             <span id="/2017/06/12/SQL Server窗口函数使用/" class="leancloud_visitors" data-flag-title="SQL Server窗口函数使用">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  2,252 字
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="什么是窗口函数-Windows-Function"><a href="#什么是窗口函数-Windows-Function" class="headerlink" title="什么是窗口函数 Windows Function"></a>什么是窗口函数 Windows Function</h2><p>窗口函数属于集合函数，作用在行集上，下面这段关于窗口函数的介绍来自 <a href="https://www.postgresql.org/docs/9.1/static/tutorial-window.html" target="_blank" rel="noopener">PostgreSQL intro windows function</a></p>
<blockquote>
<p>A window function performs a calculation across a set of table rows that are somehow related to the current row. This is comparable to the type of calculation that can be done with an aggregate function. But unlike regular aggregate functions, use of a window function does not cause rows to become grouped into a single output row — the rows retain their separate identities. Behind the scenes, the window function is able to access more than just the current row of the query result.</p>
</blockquote>
<p>窗口函数在SQL:2003标准中被添加，并在SQL:2008标准中被细化。传统的关系型数据库：Oracle、Sybase和DB2都已经支持窗口函数，像开源的PostgreSQL里面也已经有了对窗口函数的完整的实现。SQL Server 2005开始对窗口函数有了最初的支持，从SQL Server 2012开始，窗口函数也被SQL Server完全支持。</p>
<a id="more"></a>
<h2 id="SQL-Server窗口函数"><a href="#SQL-Server窗口函数" class="headerlink" title="SQL Server窗口函数"></a>SQL Server窗口函数</h2><p>窗口函数的应用非常广泛，像分页、去重、分组的基础上返回 Top N 的行、计算 Running Totals、Gaps and islands、百分率, Hierarchy 排序、Pivoting 等等。</p>
<p>窗口函数是整个SQL语句最后被执行的部分，这意味着窗口函数是在SQL查询的结果集上进行的，因此不会受到Group By， Having，Where子句的影响</p>
<p>SQL Server 窗口函数主要用来处理由 OVER 子句定义的行集, 主要用来分析和处理</p>
<ul>
<li>Running totals</li>
<li>Moving averages</li>
<li>Gaps and islands</li>
</ul>
<p>在标准的SQL中，Window Function 的OVER语句中有三个非常重要的元素:</p>
<ul>
<li>Partitioning</li>
<li>Ordering</li>
<li>Framing</li>
</ul>
<p>这三种元素的作用可以限制窗口集中的行，如果没有指定任何元素，那么窗口中包含的就是查询结果集中所有的行。</p>
<p>窗口函数的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-- Syntax for SQL Server, Azure SQL Database, and Azure SQL Data Warehouse  </span><br><span class="line"></span><br><span class="line">OVER (   </span><br><span class="line">       [ &lt;PARTITION BY clause&gt; ]  </span><br><span class="line">       [ &lt;ORDER BY clause&gt; ]   </span><br><span class="line">       [ &lt;ROW or RANGE clause&gt; ]  </span><br><span class="line">      )</span><br></pre></td></tr></table></figure>
<h3 id="Partition"><a href="#Partition" class="headerlink" title="Partition"></a>Partition</h3><blockquote>
<p>Divides the query result set into partitions. The window function is applied to each partition separately and computation restarts for each partition.</p>
</blockquote>
<p>通过PARTITION BY 得到的窗口集是基于当前查询结果的当前行的一个集，比如说 PARTITION BY CustomerID，当前行的 CustomerID = 1，那么对于当前行的这个 Window 集就是在当前查询结果之上再加上 CustomerID = 1 的一个查询结果。</p>
<h3 id="Order"><a href="#Order" class="headerlink" title="Order"></a>Order</h3><blockquote>
<p>Defines the logical order of the rows within each partition of the result set. That is, it specifies the logical order in which the window function calculation is performed.</p>
</blockquote>
<p>Order By子句对于诸如Row_Number()，Rank()，Lead()，LAG()等函数是必须的，因为如果数据无序，这些函数的结果就没有任何意义</p>
<h3 id="ROW-RANGE"><a href="#ROW-RANGE" class="headerlink" title="ROW / RANGE"></a>ROW / RANGE</h3><blockquote>
<p>Further limits the rows within the partition by specifying start and end points within the partition. This is done by specifying a range of rows with respect to the current row either by logical association or physical association. Physical association is achieved by using the ROWS clause.</p>
</blockquote>
<p>ROWS 子句通过指定当前行之前或之后的固定数目的行，限制分区中的行数。 RANGE 子句通过指定针对当前行中的值的某一范围的值，从逻辑上限制分区中的行数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ROWS BETWEEN UNBOUNDED PRECEDING |</span><br><span class="line">                   &lt;n&gt; PRECEDING |</span><br><span class="line">                   &lt;n&gt; FOLLOWING |</span><br><span class="line">             CURRENT ROW</span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">ROWS BETWEEN UNBOUNDED FOLLOWING |</span><br><span class="line">                   &lt;n&gt; PRECEDING |</span><br><span class="line">                   &lt;n&gt; FOLLOWING |</span><br><span class="line">             CURRENT ROW</span><br></pre></td></tr></table></figure>
<ul>
<li>UNBOUNDED PRECEDING 指的是相对于当前行来说之前的所有的行</li>
<li>UNBOUNDED FOLLOWING 指的是相对于当前行来说之后的所有的行</li>
<li>CURRENT ROW 就是当前行</li>
</ul>
<h2 id="简单的例子"><a href="#简单的例子" class="headerlink" title="简单的例子"></a>简单的例子</h2><p>下面用一个简单的例子表示传统的聚合函数和窗口函数的区别</p>
<p>有一个需求：将AdventureWorks示例数据库中的Employee表按照性别进行聚合，希望得到的结果是：”登录名，性别，该性别所有员工的总数”</p>
<p>那么传统的写法是用子查询获得按照性别进行聚合的值，然后再关联</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>  [LoginID]</span><br><span class="line">      , [Gender]</span><br><span class="line">      , (<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> [AdventureWorks2012].[HumanResources].[Employee] a <span class="keyword">WHERE</span> a.Gender=b.Gender) <span class="keyword">AS</span> GenderTotal</span><br><span class="line"><span class="keyword">FROM</span> [AdventureWorks2012].[HumanResources].[Employee] b</span><br></pre></td></tr></table></figure>
<p>如果使用窗口函数完成这个功能，代码如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [LoginID]</span><br><span class="line">     , [Gender]</span><br><span class="line">     , <span class="keyword">COUNT</span>(*) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> Gender) <span class="keyword">AS</span> GenderTotal</span><br><span class="line"><span class="keyword">FROM</span> [AdventureWorks2012].[HumanResources].[Employee]</span><br></pre></td></tr></table></figure>
<p><img src="http://7xkfga.com1.z0.glb.clouddn.com/executionCompare1.png" alt="ExecutionPlanCompare"></p>
<h2 id="窗口函数与-Group-子查询语句的比较"><a href="#窗口函数与-Group-子查询语句的比较" class="headerlink" title="窗口函数与 Group, 子查询语句的比较"></a>窗口函数与 Group, 子查询语句的比较</h2><p>对于Group来说，SELECT语句中的列必须是Group子句中出现的列或者是聚合列，那么如果需要同时在 SELECT 语句中查询其它的非 Group 或者非聚合列, 那么就需要额外的子查询。</p>
<p>一个和上面例子很相似的情景，比如要查询每个客户的每个订单的值，以及这个订单于这个订单客户的所有订单总和比，以及这个订单与这个客户所有订单平均值的差。</p>
<p>一个SELECT语句肯定是搞不定的，如下面代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">WITH Aggregates AS</span><br><span class="line">(</span><br><span class="line">   <span class="keyword">SELECT</span> custid</span><br><span class="line">        , <span class="keyword">SUM</span>(val) <span class="keyword">AS</span> sumval</span><br><span class="line">        , <span class="keyword">AVG</span>(val) <span class="keyword">AS</span> avgval</span><br><span class="line">   <span class="keyword">FROM</span> Sales.OrderValues</span><br><span class="line">   <span class="keyword">GROUP</span> <span class="keyword">BY</span> custid</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> O.orderid</span><br><span class="line">     , O.custid</span><br><span class="line">     , O.val</span><br><span class="line">     , <span class="keyword">CAST</span>(<span class="number">100.</span> * O.val / A.sumval <span class="keyword">AS</span> <span class="built_in">NUMERIC</span>(<span class="number">5</span>, <span class="number">2</span>)) <span class="keyword">AS</span> pctcust</span><br><span class="line">     , O.val - A.avgval <span class="keyword">AS</span> diffcust</span><br><span class="line"><span class="keyword">FROM</span> Sales.OrderValues <span class="keyword">AS</span> O</span><br><span class="line"><span class="keyword">JOIN</span> Aggregates <span class="keyword">AS</span> A</span><br><span class="line"><span class="keyword">ON</span> O.custid = A.custid;</span><br></pre></td></tr></table></figure>
<p>因为没有办法在一个Group查询中同时显示 Detail和汇总的信息</p>
<p>如果这时再加一个比 - 单个订单与总订单额/平均额比，这时汇总的级别又不相同了， 需要单独再汇总一次</p>
<p>额~ 又要添加一层子查询聚合</p>
<p>如果提出更多的聚合和比较，查询语句会越来越复杂，并且查询优化器也不能确定每次是否都访问的是同一个数据集，因此需要分别访问数据集，造成性能下降。</p>
<p>通过使用窗口函数可以很容易解决这些问题，因为可以为每一种聚合定义一个窗口上下文。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> orderid</span><br><span class="line">     , custid</span><br><span class="line">     , val</span><br><span class="line">     , <span class="keyword">CAST</span>(<span class="number">100.</span>* val/ <span class="keyword">SUM</span>(val) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> custid) <span class="keyword">AS</span> <span class="built_in">NUMERIC</span>(<span class="number">5</span>,<span class="number">2</span>)) <span class="keyword">AS</span> pctcut</span><br><span class="line">     , val - <span class="keyword">AVG</span>(val) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> custid) <span class="keyword">AS</span> diffcust</span><br><span class="line">     , <span class="keyword">CAST</span>(<span class="number">100.</span>* val/ <span class="keyword">SUM</span>(val) <span class="keyword">OVER</span>() <span class="keyword">AS</span> <span class="built_in">NUMERIC</span>(<span class="number">5</span>,<span class="number">2</span>)) <span class="keyword">AS</span> pctall</span><br><span class="line">     , val - <span class="keyword">AVG</span>(val) <span class="keyword">OVER</span>() <span class="keyword">AS</span> diffall</span><br><span class="line"><span class="keyword">FROM</span> Sales.OrderValues</span><br></pre></td></tr></table></figure>
<h2 id="使用窗口函数的例子"><a href="#使用窗口函数的例子" class="headerlink" title="使用窗口函数的例子"></a>使用窗口函数的例子</h2><h3 id="将-OVER-子句与-ROW-NUMBER-函数结合使用"><a href="#将-OVER-子句与-ROW-NUMBER-函数结合使用" class="headerlink" title="将 OVER 子句与 ROW_NUMBER 函数结合使用"></a>将 OVER 子句与 ROW_NUMBER 函数结合使用</h3><p>下面的脚本将 OVER 子句与 ROW_NUMBER 函数一起使用来显示分区内各行的行号，分区由 <code>PARTITION BY PostalCode</code>确定</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ROW_NUMBER() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> PostalCode <span class="keyword">ORDER</span> <span class="keyword">BY</span> SalesYTD <span class="keyword">DESC</span>) <span class="keyword">AS</span> <span class="string">"Row Number"</span></span><br><span class="line">     , p.LastName</span><br><span class="line">     , s.SalesYTD</span><br><span class="line">     , a.PostalCode  </span><br><span class="line"><span class="keyword">FROM</span> Sales.SalesPerson <span class="keyword">AS</span> s   </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> Person.Person <span class="keyword">AS</span> p   </span><br><span class="line">  <span class="keyword">ON</span> s.BusinessEntityID = p.BusinessEntityID  </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> Person.Address <span class="keyword">AS</span> a   </span><br><span class="line">  <span class="keyword">ON</span> a.AddressID = p.BusinessEntityID  </span><br><span class="line"><span class="keyword">WHERE</span> TerritoryID <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">AND</span> SalesYTD &lt;&gt; <span class="number">0</span>  </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> PostalCode;</span><br></pre></td></tr></table></figure>
<p><img src="http://7xkfga.com1.z0.glb.clouddn.com/rowNumber.png" alt="rowNumber"></p>
<p>用这种分配行号的方法，可以完成例如分页、去除重复元素、返回每组前N条数据等实际需求</p>
<h3 id="将-OVER-子句与聚合函数结合使用"><a href="#将-OVER-子句与聚合函数结合使用" class="headerlink" title="将 OVER 子句与聚合函数结合使用"></a>将 OVER 子句与聚合函数结合使用</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> SalesOrderID, ProductID, OrderQty  </span><br><span class="line">     , <span class="keyword">SUM</span>(OrderQty) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> SalesOrderID) <span class="keyword">AS</span> Total  </span><br><span class="line">     , <span class="keyword">AVG</span>(OrderQty) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> SalesOrderID) <span class="keyword">AS</span> <span class="string">"Avg"</span>  </span><br><span class="line">     , <span class="keyword">COUNT</span>(OrderQty) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> SalesOrderID) <span class="keyword">AS</span> <span class="string">"Count"</span>  </span><br><span class="line">     , <span class="keyword">MIN</span>(OrderQty) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> SalesOrderID) <span class="keyword">AS</span> <span class="string">"Min"</span>  </span><br><span class="line">     , <span class="keyword">MAX</span>(OrderQty) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> SalesOrderID) <span class="keyword">AS</span> <span class="string">"Max"</span>  </span><br><span class="line"><span class="keyword">FROM</span> Sales.SalesOrderDetail   </span><br><span class="line"><span class="keyword">WHERE</span> SalesOrderID <span class="keyword">IN</span>(<span class="number">43659</span>,<span class="number">43664</span>);</span><br></pre></td></tr></table></figure>
<p><img src="http://7xkfga.com1.z0.glb.clouddn.com/partitionGroup.png" alt="partitionGroup"></p>
<h3 id="生成移动平均值和累计合计"><a href="#生成移动平均值和累计合计" class="headerlink" title="生成移动平均值和累计合计"></a>生成移动平均值和累计合计</h3><p>下面的示例将 AVG 和 SUM 函数与 OVER 子句结合使用，以便为 Sales.SalesPerson 表中的每个地区提供年度销售额的累计合计。 数据按 TerritoryID 分区并在逻辑上按 SalesYTD 排序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> BusinessEntityID</span><br><span class="line">     , TerritoryID   </span><br><span class="line">     , <span class="keyword">DATEPART</span>(yy,ModifiedDate) <span class="keyword">AS</span> SalesYear  </span><br><span class="line">     , <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">20</span>),SalesYTD,<span class="number">1</span>) <span class="keyword">AS</span>  SalesYTD  </span><br><span class="line">     , <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">20</span>),<span class="keyword">AVG</span>(SalesYTD) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> TerritoryID   </span><br><span class="line">                                            <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">DATEPART</span>(yy,ModifiedDate)   </span><br><span class="line">                                           ),<span class="number">1</span>) <span class="keyword">AS</span> MovingAvg  </span><br><span class="line">     , <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">20</span>),<span class="keyword">SUM</span>(SalesYTD) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> TerritoryID   </span><br><span class="line">                                            <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">DATEPART</span>(yy,ModifiedDate)   </span><br><span class="line">                                            ),<span class="number">1</span>) <span class="keyword">AS</span> CumulativeTotal  </span><br><span class="line"><span class="keyword">FROM</span> Sales.SalesPerson  </span><br><span class="line"><span class="keyword">WHERE</span> TerritoryID <span class="keyword">IS</span> <span class="literal">NULL</span> <span class="keyword">OR</span> TerritoryID &lt; <span class="number">5</span>  </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> TerritoryID, SalesYear;</span><br></pre></td></tr></table></figure>
<p>在 OVER 子句中指定的 ORDER BY 子句将确定应用 AVG 函数的逻辑顺序。</p>
<p>再往下，ORDER BY之后也可以指定 ROWS 子句进一步限制窗口的大小</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> BusinessEntityID, TerritoryID   </span><br><span class="line">     , <span class="keyword">DATEPART</span>(yy,ModifiedDate) <span class="keyword">AS</span> SalesYear  </span><br><span class="line">     , <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">20</span>),SalesYTD,<span class="number">1</span>) <span class="keyword">AS</span>  SalesYTD  </span><br><span class="line">     , <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">20</span>),<span class="keyword">SUM</span>(SalesYTD) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> TerritoryID   </span><br><span class="line">                                             <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">DATEPART</span>(yy,ModifiedDate)   </span><br><span class="line">                                             <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="keyword">CURRENT</span> <span class="keyword">ROW</span> <span class="keyword">AND</span> <span class="number">1</span> <span class="keyword">FOLLOWING</span> ),<span class="number">1</span>) <span class="keyword">AS</span> CumulativeTotal  </span><br><span class="line"><span class="keyword">FROM</span> Sales.SalesPerson  </span><br><span class="line"><span class="keyword">WHERE</span> TerritoryID <span class="keyword">IS</span> <span class="literal">NULL</span> <span class="keyword">OR</span> TerritoryID &lt; <span class="number">5</span>;</span><br></pre></td></tr></table></figure>
<p>在这个例子里面， ROWS子句 <code>ROWS BETWEEN CURRENT ROW AND 1 FOLLOWING</code> 限制窗口为： <strong>当前行的行</strong> 对其 <strong>下面1行</strong></p>
<p>所以查询结果为：</p>
<p><img src="http://7xkfga.com1.z0.glb.clouddn.com/rowsWindow.png" alt="rowsWindow"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> t.OrderYear</span><br><span class="line">     , t.OrderMonth</span><br><span class="line">     , t.TotalDue</span><br><span class="line">     , <span class="keyword">SUM</span>(t.TotalDue) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> OrderYear, OrderMonth</span><br><span class="line">                            <span class="keyword">ORDER</span> <span class="keyword">BY</span> t.OrderYear, t.OrderMonth</span><br><span class="line">                            <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="keyword">UNBOUNDED</span> <span class="keyword">PRECEDING</span> <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="keyword">ROW</span>) <span class="keyword">AS</span> <span class="string">'RunningTotal'</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">(</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="keyword">YEAR</span>(OrderDate) <span class="keyword">AS</span> <span class="string">'OrderYear'</span></span><br><span class="line">         , <span class="keyword">MONTH</span>(OrderDate) <span class="keyword">AS</span> <span class="string">'OrderMonth'</span></span><br><span class="line">         , SalesPersonID</span><br><span class="line">         , TotalDue</span><br><span class="line">	<span class="keyword">FROM</span> Sales.SalesOrderHeader </span><br><span class="line">) <span class="keyword">AS</span> t</span><br><span class="line"><span class="keyword">WHERE</span> t.SalesPersonID = <span class="number">274</span> <span class="keyword">AND</span> t.OrderYear = <span class="number">2005</span></span><br></pre></td></tr></table></figure>
<p>在这个例子中，窗口被限制为：第一行 (<code>UNBOUNDED PRECEDING</code>) 到当前行 (<code>CURRENT ROW</code>)</p>
<p>查询结果为：</p>
<p><img src="http://7xkfga.com1.z0.glb.clouddn.com/rows2.png" alt="row2"></p>
<p>所以11月份的累计总和为4723 和 7140<code>(4723.1073+2417.4793)</code></p>
<p>如果把<code>ROWS</code>限制改成<code>RANGE</code>会怎么样呢?</p>
<p>结果如下：</p>
<p><img src="http://7xkfga.com1.z0.glb.clouddn.com/RANGE2.png" alt="rangeWindows"></p>
<p>RANGE选项包含窗口里的所有行，和当前行有相同ORDER BY值。上面的例子里面，对于2005年11月的2条记录你拿到同个汇总，因为这2行有<strong>同样的ORDER BY值（2005年11月）</strong></p>
<p><strong>note: 使用ROWS选项你在物理级别定义在你窗口里有多少行。使用RANGE选项取决于ORDER BY值在窗口里有多少行被包含</strong></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/uploads/WeChatImage_20170527190034.jpg" alt="Shuo Lv WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
    </div>
  </div>


      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/SQL-Server/" rel="tag"># SQL Server</a>
          
            <a href="/tags/SQL/" rel="tag"># SQL</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/08/Anaconda解决python包管理与环境管理/" rel="next" title="Anaconda解决python包管理与环境管理">
                <i class="fa fa-chevron-left"></i> Anaconda解决python包管理与环境管理
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/12/(转)Python基础知识面试题/" rel="prev" title="(转)Python基础知识面试题">
                (转)Python基础知识面试题 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yODkwOC81NDc3"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="Shuo Lv" />
          <p class="site-author-name" itemprop="name">Shuo Lv</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">72</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">50</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/lvraikkonen" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/1246109477/profile?topnav=1&wvr=6" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/lu-shuo-53/activities" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-quora"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.linkedin.com/in/shuo-lv-58881823/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-linkedin"></i>
                  
                  LinkedIn
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/shuo.lv" target="_blank" title="Facebook">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                  Facebook
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://webdemo.myscript.com/views/math.html/" title="公式编辑器" target="_blank">公式编辑器</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.pythontutor.com/" title="可视化Python代码" target="_blank">可视化Python代码</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://docs.python-guide.org/en/latest/" title="Python最佳实践" target="_blank">Python最佳实践</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是窗口函数-Windows-Function"><span class="nav-number">1.</span> <span class="nav-text">什么是窗口函数 Windows Function</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL-Server窗口函数"><span class="nav-number">2.</span> <span class="nav-text">SQL Server窗口函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Partition"><span class="nav-number">2.1.</span> <span class="nav-text">Partition</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Order"><span class="nav-number">2.2.</span> <span class="nav-text">Order</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ROW-RANGE"><span class="nav-number">2.3.</span> <span class="nav-text">ROW / RANGE</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#简单的例子"><span class="nav-number">3.</span> <span class="nav-text">简单的例子</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#窗口函数与-Group-子查询语句的比较"><span class="nav-number">4.</span> <span class="nav-text">窗口函数与 Group, 子查询语句的比较</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用窗口函数的例子"><span class="nav-number">5.</span> <span class="nav-text">使用窗口函数的例子</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#将-OVER-子句与-ROW-NUMBER-函数结合使用"><span class="nav-number">5.1.</span> <span class="nav-text">将 OVER 子句与 ROW_NUMBER 函数结合使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将-OVER-子句与聚合函数结合使用"><span class="nav-number">5.2.</span> <span class="nav-text">将 OVER 子句与聚合函数结合使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成移动平均值和累计合计"><span class="nav-number">5.3.</span> <span class="nav-text">生成移动平均值和累计合计</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shuo Lv</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.1"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("QttC3P4LGflMxbppLnNEY62a-gzGzoHsz", "joh41qpX9cxG63me5aR8vKXx");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  


  <!-- 背景动画 -->
  <script type="text/javascript" src="/js/src/particle.js"></script>

</body>
</html>
